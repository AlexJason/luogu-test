# 网络流
## 网络流
### 网络
**网络**指一个有向图 $G=(V,E)$。

每条边 $(u,v)\in E$ 都有一个权值 $c(u,v)$ 称为**容量（Capacity）**，特别地，规定 $(u,v)\not\in E$ 时 $c(u,v)=0$。

其中对于 $s\in V$ 称为**源点（Source）**，$t\in V$称为**汇点（Slink）**。

### 流
设 $f(u,v)$ 是定义在 $(u\in V, v\in V)$ 上的函数且满足：
1. **容量限制**：$f(u,v)\le c(u,v)$
2. **斜对称性**：$f(u,v)=-f(u,v)$
3. **流守恒性**：$\forall x\in V-\{s,t\}$ 满足 $\sum_{(u,x)\in E}f(u,x)=\sum_{(x,v)\in E}f(x,v)$

称 $f$ 为网络 $G=(V,E)$ 的**流函数**，$f(u,v)$ 称为边 $(u,v)$的**流量**，$c_f(u,v)=c(u,v)-f(u,v)$ 称为边 $(u,v)$ 的**剩余容量**。

显然：
$$
f(u,v)=\begin{cases}
    f(u,v), & (u,v)\in E \\
    -f(v,u), & (v,u)\in E \\
    0, & (u,v)\not\in E, (v,u)\not\in E
\end{cases}
$$

整个网络的流量为 $\sum_{(s,v)\in E}f(s,v)$ 即**源点所有出边的流量和**。

对于某一条路径上的边集 $P$，这条路径的总流量为 $\min\{f(u,v)|(u,v)\in P\}$。

## 最大流
### 概念
对于流函数 $f$，**残量网络（Residual Capacity）** $G_f$ 是网络 $G$ 中所有结点和剩余容量大于0的边构成的子图。
$$G_f=(V_f=V,E_f=\{(u,v)|(u,v)\in E, c_f(u,v)\gt 0\})$$

对于某一条路径上的边集 $P$，这条路径的最小残量为 $\min\{c_f(u,v)|(u,v)\in P\}$。

**残量网络中可能包含虚边**

在 $G$ 中若一条从源点到汇点的路径上所有边的剩余容量**都**大于 0，这条路称为**增广路（Augmenting Path）**。

### Edmond-Karp算法
使用BFS找增广路，然后对其增广。
1. 搜索：从源点BFS，判断流量是否合法，碰到汇点停止并增广（每一条路都要增广）。
2. 增广：按增广路重走一遍，并将所有的正边减去增广路的最小残量，并将反边加上最小残量。

一般地，对于链式前向星，相邻存储的两条边 $E_{2k}, E_{2k+1}, k\in N^{*}$ 作为一组边，则对于下标为 $i$ 的边，其反边为 $i\rm{xor} 1$。

算法复杂度为 $O(nm^2)$，其中 $n$ 为点数，$m$ 为边数。

### Dinic算法
1. 使用BFS将图分层，设源点的层数为 $0$，则一个点的层数是其离源点的最近距离。
2. DFS寻找增广路，只找比当前点层数多 $1$ 的点，确保搜索到的增广路是最短的。

**多路增广优化**：每次找到一个增广路时，利用残余流量，再找出一条增广路。

**当前弧优化**：如果一条边被增广过，则不可能被增广第二次，因此下一次增广就不必走已经被增广过的边。

### ISAP算法（Improved Shortest Augment Path）
1. 使用BFS在反向图上分层，令汇点的层数为 $0$，之后不再分层。
2. DFS寻找增广路，只找比当前点层数少 $1$ 的点，确保搜索到的增广路是最短的。
3. 结束 $i$ 点的增广后，遍历残量网络上 $i$ 的所有出边，找到层最小的出点 $j$，并将 $i$ 的层修改为 $j$ 的层加 $1$。如果残量网络上 $i$ 没有出边，则层数修改为结点数 $n$。显然当源点的层数大于等于 $n$ 时，不存在增广路。

**当前弧优化**：同Dinic。

**GAP优化**：记录层数为 $i$ 的点的数量为 $num_i$，当一个点的层数 $x$ 被更新到 $y$ 时，同时更新 $num$ 数组的值，若更新后 $num_x=0$，意味着图上出现了断层，即无法找到增广路。

## 费用流
### 概念
给定网络 $G=(V,E)$，每条边的容量为 $c(u,v)$，单位流量的费用为 $w(u,v)$，即当 $(u,v)$ 的流量为 $f(u,v)$ 时，费用为 $f(u,v)\times w(u,v)$。

费用满足斜对称性，即 $w(u,v)=-w(v,u)$。

该网络中总花费最小的最大流称为**最小费用最大流**，即在最大化 $\sum_{(s,v)\in E}f(s,v)$ 的前提下最小化 $\sum_{(u,v)\in E}f(u,v)\times w(u,v)$。


